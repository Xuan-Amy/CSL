<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>æµè§ˆå™¨å®æ—¶è¯†åˆ«</title>
  <style>
    body {
      background: #f0f2f5;
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }
    video {
      border: 3px solid #007bff;
      border-radius: 8px;
      margin-top: 20px;
    }
    #result {
      margin-top: 20px;
      font-size: 18px;
      color: #222;
    }
  </style>
</head>
<body>
  <h2>ğŸ“· æœ¬åœ°æ‘„åƒå¤´è¯†åˆ«ï¼ˆWebSocket å®æ—¶ï¼‰</h2>
  <video id="video" width="640" height="480" autoplay playsinline muted></video>
  <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
  <div id="result">ç­‰å¾…æ‘„åƒå¤´æˆæƒ...</div>

  <script>
window.addEventListener("DOMContentLoaded", () => {
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const resultDiv = document.getElementById("result");

  console.log("ğŸ“¢ é¡µé¢å·²åŠ è½½ï¼Œå°è¯•è¿æ¥æ‘„åƒå¤´...");

  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      console.log("âœ… æ‘„åƒå¤´æƒé™å·²è·å¾—");
      resultDiv.innerText = "âœ… æ‘„åƒå¤´å·²å¯ç”¨ï¼Œå¼€å§‹è¯†åˆ«...";
      video.srcObject = stream;

      // WebSocket åˆå§‹åŒ–ï¼ˆç­‰æ‘„åƒå¤´ OK åå†å¯åŠ¨ï¼‰
      const ws = new WebSocket("ws://" + location.host + "/ws/recognize");

      ws.onopen = () => console.log("âœ… WebSocket è¿æ¥æˆåŠŸ");
      ws.onerror = err => console.error("âŒ WebSocket é”™è¯¯", err);
      ws.onclose = () => console.warn("âš ï¸ WebSocket è¿æ¥å…³é—­");

      ws.onmessage = function (event) {
        const data = JSON.parse(event.data);
        resultDiv.innerText = `å·¦æ‰‹: ${data.left} ï½œ å³æ‰‹: ${data.right}`;
      };

      // æ¯ 200ms æ¨é€ä¸€å¸§
      setInterval(() => {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imgData = canvas.toDataURL("image/jpeg");
        if (ws.readyState === WebSocket.OPEN) {
          ws.send(imgData);
        }
      }, 200);
    })
    .catch(err => {
      alert("âŒ æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·åœ¨æµè§ˆå™¨åœ°å€æ ç‚¹å‡»å°æ‘„åƒå¤´å›¾æ ‡æ‰‹åŠ¨å¼€å¯æƒé™");
      resultDiv.innerText = "âŒ æ‘„åƒå¤´æƒé™è¢«æ‹’ç»";
      console.error("ğŸš¨ getUserMedia å‡ºé”™:", err);
    });
});
</script>

</body>
</html>
