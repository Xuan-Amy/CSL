<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>WebSocket å®æ—¶è¯†åˆ«</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
      background: #f0f2f5;
    }
    video, canvas {
      border: 3px solid #007bff;
      border-radius: 8px;
      margin-top: 20px;
    }
    #result {
      margin-top: 20px;
      font-size: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h2>ğŸ“· WebSocket å®æ—¶è¯†åˆ«é¡µé¢</h2>

<!-- æ‘„åƒå¤´ç”»é¢ -->
<video id="video" width="640" height="480" autoplay playsinline></video>
<canvas id="canvas" width="640" height="480" style="display: none;"></canvas>

<!-- å®æ—¶è¯†åˆ«ç»“æœ -->
<div id="result">è¯†åˆ«ç»“æœï¼š<span id="left">-</span> / <span id="right">-</span></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("ğŸš€ DOM å®Œæˆï¼Œå‡†å¤‡è°ƒç”¨ getUserMedia");

  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    alert("âŒ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ getUserMedia");
    return;
  }

  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      console.log("âœ… æˆåŠŸè·å–æ‘„åƒå¤´æµ");
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      video.srcObject = stream;
      video.play();

      // âœ… è‡ªåŠ¨åˆ‡æ¢ ws:// æˆ– wss://
      const ws_protocol = location.protocol === "https:" ? "wss://" : "ws://";
      const ws = new WebSocket(ws_protocol + location.host + "/ws/recognize");

      let readyToSend = true;

      ws.onopen = () => console.log("ğŸ”— WebSocket å·²è¿æ¥");

      ws.onmessage = event => {
        const data = JSON.parse(event.data);
        document.getElementById("left").textContent = data.left || "-";
        document.getElementById("right").textContent = data.right || "-";
        readyToSend = true; // âœ… åªæœ‰æ”¶åˆ°è¿”å›æ‰å…è®¸å‘é€ä¸‹ä¸€å¸§
      };

      function sendFrame() {
        if (
          video.readyState >= 2 &&
          ws.readyState === WebSocket.OPEN &&
          readyToSend
        ) {
          readyToSend = false;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          canvas.toBlob(blob => {
            if (blob) {
              ws.send(blob);
            } else {
              readyToSend = true; // å¦‚æœå‡ºé”™ï¼Œé‡Šæ”¾é”
            }
          }, "image/jpeg");
        }
        requestAnimationFrame(sendFrame); // ç”¨æ›´çµæ´»çš„åˆ·æ–°æœºåˆ¶ä»£æ›¿ setInterval
      }

      sendFrame(); // â¬…ï¸ å¼€å§‹å‘é€å¾ªç¯
    })
    .catch(err => {
      alert(`âŒ æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼š${err.name} - ${err.message}`);
      console.error("ğŸš« getUserMedia é”™è¯¯è¯¦æƒ…ï¼š", err);
    });
});
</script>




</body>
</html>
